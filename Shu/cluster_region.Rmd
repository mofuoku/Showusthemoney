---
title: "cluster_region"
author: "Shu Zhang"
date: "8/21/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 

```{r cars}
library(ggplot2)
library(GGally)
library(dplyr)
library(Hmisc)
library(kknn)
library(lubridate)
library(ggthemes)
library(data.table)
library(caret)

```


```{r pressure, echo=FALSE}
properties <- read.csv('properties_2016.csv', header = TRUE, stringsAsFactors = FALSE)
train <- read.csv('train_2016_v2.csv',header = TRUE, stringsAsFactors = FALSE)
```

```{r}
date <- train %>% mutate(year_month = make_date(year = year(transactiondate),month=month(transactiondate)))

date_ds <- date %>%
  group_by(year_month) %>%
  summarise(count = n())

```

##  Missingness

### Summarize the missing values in the data.
```{r}
total <- NULL
percent <- NULL
for (i in 1:length(colnames(properties))) {
  total[i] <- sum(is.na(properties[,i]))
  percent[i] <- round(total[i]/nrow(original),4)
}

missingValues <- data.frame(variables=colnames(properties),total=total, percent=percent)
missingValues <- missingValues %>% filter(percent > 0)
# missingValues
```


```{r}
deleteVariables <- missingValues %>% filter(percent > 0.15) %>% arrange(desc(percent))
```
### Delete columns that having more than 15% of missing values.

```{r}
# need_col contains only the undelete variables
needed_col <- colnames(properties)[!(colnames(properties) %in% deleteVariables$variables)]


properties_clean <- properties %>%
  select(one_of(needed_col))
dim(properties_clean) # The dataset after reducing the missing-value columns has 29 variables.
```
### Delete columns that are duplicated with other columns.
'calculatedbathnbr' = 'bathroomcnt' <br />
'fips' = 'regionidcounty'<br />
'calculatedfinishedsquarefeet' = 'finishedsquarefeet12'<br />
'fullbathcnt' = 'bathroomcnt'
```{r}
col_drop <- c("fips","calculatedbathnbr","finishedsquarefeet12","fullbathcnt")
cl = properties_clean[ ,-which(colnames(properties_clean) %in% col_drop)]
properties_clean <- cl


# number of properties per regionzip
#num_prop_zip <- properties_clean %>%
  #group_by(regionidzip) %>%
  #summarise(numpropperzip = n())

#properties_clean$propperzip = num_prop_zip$numpropperzip[match(properties_clean$regionidzip,num_prop_zip$regionidzip)]
```
### categorical/numeric subsets
```{r}
categorical <- names(properties_clean[,sapply(properties_clean,class)=="integer"])

categorical <- append(categorical,"rawcensustractandblock")
categorical <- append(categorical, "bathroomcnt")
categorical <- append(categorical, "roomcnt")
categorical <- append(categorical,"censustractandblock")
categorical <- append(categorical,"bedroomcnt")
categorical<- append(categorical,"hashottuborspa")
categorical <- append(categorical,"yearbuilt")
categorical <- append(categorical,"taxdelinquencyflag")
categorical <- append(categorical,"fireplaceflag")
categorical <- append(categorical,"bedroomcnt")
numeric_ <- names(properties_clean)[-which(names(properties_clean) %in% categorical)]
#numeric_ <- numeric_[-8] # rm assessmentyear
numeric_ <- numeric_[-c(3,4)] #rm "propertycountylandusecode","propertyzoningdesc"

categorical <- categorical[-8] # rm assessmentyear
categorical <- categorical[-17] #rm extra bedrooomcnt

categorical_set <- properties_clean[,categorical]
numeric_set <- properties_clean[,numeric_]

# Impute missing values in numeric_set
pre <- preProcess(numeric_set,method = "medianImpute")
numeric_set <- predict(pre,numeric_set) 

# numeric_set <- scale(numeric_set)

# rm na in categorical set

#numeric_set <- numeric_set[complete.cases(categorical_set),]

#categorical_set <- categorical_set[complete.cases(categorical_set),]

# Set all missing values in categorical cols = 0
categorical_set[is.na(categorical_set)] = 0

properties_clean <- cbind(numeric_set,categorical_set)
#View(properties_clean)
#sum(!complete.cases(properties_clean))
#names(properties_clean)
properties_clean <- properties_clean[,c(7,1:6,8:22)]
```
### Roomcnt Modify
```{r}
# change 0 to an appropriate number
properties_clean$roomcnt[properties_clean$roomcnt == 0] <- properties_clean$bathroomcnt[properties_clean$roomcnt == 0] + properties_clean$bedroomcnt[properties_clean$roomcnt == 0] + 1


# dummy var
properties_clean$hashottuborspa <- ifelse(properties_clean$hashottuborspa == "",0,1)
properties_clean$fireplaceflag <- ifelse(properties_clean$fireplaceflag == "",0,1)
properties_clean$taxdelinquencyflag <- ifelse(properties_clean$taxdelinquencyflag == "",0,1)
```

### feature eg
```{r}
# sqft per room
properties_clean <- properties_clean %>%
  mutate(sqftperrm = calculatedfinishedsquarefeet/roomcnt)

# tax per sqft
# We use taxvaluedollarcnt here.(The total tax assessed value of the parcel)
properties_clean <- properties_clean %>%
  mutate(taxpersqft = taxvaluedollarcnt/calculatedfinishedsquarefeet)
```
### Cluster
#### Choose region related variables
```{r}
ds_col <- c("taxvaluedollarcnt","taxamount","regionidcity","regionidcounty","yearbuilt","structuretaxvaluedollarcnt","bathroomcnt","bedroomcnt","roomcnt","taxpersqft","sqftperrm")
ds <- properties_clean[,which(colnames(properties_clean) %in% ds_col)]
ds <- scale(ds)

```

```{r}
level1 <- kmeans(ds,5)$cluster
```

```{r}
properties_clean$level <- level1
```

```{r}
dim(properties_clean)
```
```{r}
write.csv(properties_clean,'properties_clean.csv',row.names = FALSE)
```


### Join datasets

```{r}

```




ds <- properties_clean[,which(colnames(properties_clean) %in% ds_col)]




```{r}
write.csv(ds, 'region.csv',row.names = FALSE)
```
### Cluster on training set
```{r}
ds2 <- read.csv('train_set_nonscaled.csv',header = TRUE,stringsAsFactors = FALSE)
ds2 <- scale(ds2)

ds_col <- c("taxvaluedollarcnt","taxamount","yearbuilt","structuretaxvaluedollarcnt","bathroomcnt","bedroomcnt","roomcnt","taxpersqft","sqftperrm")
ds2 <- ds2[,which(colnames(ds2) %in% ds_col)]

train_set_nonscaled <- read.csv('train_set_nonscaled.csv',header = TRUE,stringsAsFactors = FALSE)

level <- kmeans(ds2,5)$cluster
train_set_nonscaled2 <- data.frame(train_set_nonscaled,level=level)

write.csv(train_set_nonscaled2,"train_set_nonscaled2.csv",row.names = FALSE)
```



